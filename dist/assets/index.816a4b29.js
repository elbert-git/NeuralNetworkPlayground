var it=Object.defineProperty;var nt=(r,t,e)=>t in r?it(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e;var n=(r,t,e)=>(nt(r,typeof t!="symbol"?t+"":t,e),e),rt=(r,t,e)=>{if(!t.has(r))throw TypeError("Cannot "+e)};var m=(r,t,e)=>{if(t.has(r))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(r):t.set(r,e)};var p=(r,t,e)=>(rt(r,t,"access private method"),e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const o of a.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function e(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerpolicy&&(a.referrerPolicy=i.referrerpolicy),i.crossorigin==="use-credentials"?a.credentials="include":i.crossorigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(i){if(i.ep)return;i.ep=!0;const a=e(i);fetch(i.href,a)}})();let F=null;class b{constructor(){n(this,"processes");n(this,"updateRate");if(this.processes=[],this.updateRate=60,F)return F;F=this,this.update()}update(){this.processes.forEach(t=>{t.update()}),requestAnimationFrame(this.update.bind(this))}}function S(r){return r*(Math.PI/180)}function C(r,t,e){return r+e*(t-r)}function E(r=1){return(Math.random()*2-1)*r}function A(r,t=-1,e=1){let s=r;return s>e&&(s=e),s<t&&(s=t),s}class c{constructor(t,e){n(this,"x");n(this,"y");this.x=t,this.y=e}add(t){return new c(this.x+t.x,this.y+t.y)}subtract(t){return new c(this.x-t.x,this.y-t.y)}rotate(t){return new c(this.x*Math.cos(S(t))-this.y*Math.sin(S(t)),this.x*Math.sin(S(t))+this.y*Math.cos(S(t)))}scale(t){return new c(this.x*t,this.y*t)}magnitude(){return Math.sqrt(Math.pow(this.x,2)+Math.pow(this.y,2))}}var L,q;class at{constructor(t){m(this,L);n(this,"parentElement");n(this,"elCanvas");n(this,"ctx");n(this,"center");n(this,"size");n(this,"cameraPosition");n(this,"camearaViewScale");n(this,"cameraSubject");this.parentElement=t,this.elCanvas=document.createElement("canvas"),this.elCanvas.classList.add("debugRedLine","roadCanvas"),this.ctx=this.elCanvas.getContext("2d"),this.parentElement.appendChild(this.elCanvas),this.center=new c(0,0),this.cameraPosition=new c(0,0);const e=2;this.camearaViewScale=new c(1/e,1/e),this.cameraSubject=null,this.size={x:0,y:0},window.addEventListener("resize",this.onResize.bind(this)),this.onResize()}onResize(){this.size={x:this.parentElement.clientWidth,y:this.parentElement.clientHeight},this.elCanvas.width=this.size.x,this.elCanvas.height=this.size.y,this.center=new c(Math.floor(this.size.x/2),Math.floor(this.size.y/2))}clear(){this.ctx.fillStyle="#333333",this.ctx.beginPath(),this.ctx.rect(0,0,this.size.x,this.size.y),this.ctx.fill()}draw(t){this.clear(),p(this,L,q).call(this),this.ctx.save(),this.ctx.translate(this.center.x-this.cameraPosition.x,this.center.y-this.cameraPosition.y),this.ctx.scale(this.camearaViewScale.x,this.camearaViewScale.y),Object.keys(t).forEach(e=>{t[e].draw(this.ctx)}),this.ctx.restore();//! temp put camera control here
}}L=new WeakSet,q=function(){if(this.cameraSubject){const t=this.cameraSubject.position.scale(this.camearaViewScale.x);t.x=0,this.cameraPosition=t}};class ot{constructor(){n(this,"objects");n(this,"canvas");n(this,"colliderGroups");this.objects={},this.canvas=new at(document.getElementById("road")),this.colliderGroups={}}update(){this.canvas.draw(this.objects)}addObject(t,e){this.objects[t]=e,this.addObjectToColliderGroups(e)}addObjectToColliderGroups(t){const e=t.physicsData.colliderTag;e&&(this.colliderGroups[e]?this.colliderGroups[e].push(t):this.colliderGroups[e]=[t]),t.children&&t.children.forEach(s=>{this.addObjectToColliderGroups(s)})}}class Z{constructor(){n(this,"stroke");n(this,"fill");n(this,"fillStyle");n(this,"strokeStyle");n(this,"closePath");n(this,"lineWidth");n(this,"lineDash");n(this,"images");n(this,"imageSize");n(this,"opacity");this.stroke=!1,this.fill=!0,this.fillStyle="white",this.strokeStyle="black",this.lineDash=[],this.closePath=!0,this.lineWidth=1,this.images=[],this.imageSize=new c(0,0),this.opacity=1}addImage(t,e,s){this.images.push(t),this.imageSize=new c(e,s)}}class P{constructor(t,e){n(this,"a");n(this,"b");this.a=t,this.b=e}getIntersectionWith(t){const e=(t.a.x-t.b.x)*(this.a.y-t.b.y)-(t.a.y-t.b.y)*(this.a.x-t.b.x),s=(t.b.y-this.a.y)*(this.a.x-this.b.x)-(t.b.x-this.a.x)*(this.a.y-this.b.y),i=(t.a.y-t.b.y)*(this.b.x-this.a.x)-(t.a.x-t.b.x)*(this.b.y-this.a.y);if(i!==0){const a=e/i,o=s/i;return a>=0&&a<=1&&o>=0&&o<=1?new c(C(this.a.x,this.b.x,a),C(this.a.y,this.b.y,a)):null}else return null}static getEdges(t,e=!0){const s=[];for(let i=0;i<t.length-1;i++){const a=new P(t[i],t[i+1]);s.push(a)}return e&&s.push(new P(t[t.length-1],t[0])),s}}var I,K;class y{constructor(t){m(this,I);n(this,"position");n(this,"rotation");n(this,"polygon");n(this,"style");n(this,"children");n(this,"parentPosition");n(this,"parentAngle");n(this,"physicsData");this.position=new c(0,0),this.rotation=0,this.polygon=t,this.style=new Z,this.children=[],this.parentPosition=new c(0,0),this.parentAngle=0,this.physicsData={enabled:!1,colliderTag:null,collidesWith:[]}}draw(t){t.beginPath(),this.update(),this.physicsData.enabled&&this.handlePhysics(),this.children.forEach(s=>{s.parentPosition=this.position.add(this.parentPosition),s.parentAngle=this.rotation+this.parentAngle,s.draw(t)});const e=this.computeTransformedVertices();if(e.forEach((s,i)=>{i===0?(t.beginPath(),t.moveTo(s.x,s.y)):t.lineTo(s.x,s.y)}),p(this,I,K).call(this,t),this.style.closePath&&t.closePath(),this.style.fill&&t.fill(),this.style.stroke&&t.stroke(),this.style.images.length>0){const s=this.rotation,i=S(s);t.rotate(i);const l=e[0].subtract(this.position).rotate(0).add(this.position).rotate(-s);for(let h=0;h<this.style.images.length;h++)t.drawImage(this.style.images[h],l.x,l.y,this.style.imageSize.x,this.style.imageSize.y);t.rotate(-i)}}computeTransformedVertices(){let t=[...this.polygon.vertices];return t=t.map(e=>e.rotate(this.rotation+this.parentAngle).add(this.position.add(this.parentPosition))),t}update(){}handlePhysics(){const t=new b().processes[0];let e=[];this.physicsData.collidesWith.length>0&&this.physicsData.collidesWith.forEach(i=>{e=[...e,...t.colliderGroups[i]]});let s=[];for(let i=0;i<e.length;i++)s=[...s,...this.checkCollisionWith(e[i])];s.length>0&&this.onCollision(s)}checkCollisionWith(t){const e=this.computeTransformedVertices(),s=P.getEdges(e),i=t.computeTransformedVertices(),a=P.getEdges(i),o=[];for(let l=0;l<s.length;l++)for(let h=0;h<a.length;h++){const w=s[l],G=a[h],f=w.getIntersectionWith(G);f&&o.push(f)}return o}onCollision(t){}}I=new WeakSet,K=function(t){t.fillStyle=this.style.fillStyle,t.strokeStyle=this.style.strokeStyle,t.lineWidth=this.style.lineWidth,t.setLineDash(this.style.lineDash),t.globalAlpha=this.style.opacity};class g{constructor(t){n(this,"vertices");this.vertices=t}}const z=400,lt=-1e5,ct=5,d={roadWidth:z,roadHeight:lt,laneCount:ct,allLanesWidth:z-15};function ht(r,t){const e=new y(new g([new c(-r,0),new c(r,0),new c(r,t),new c(-r,t)]));return e.style.fillStyle="#a6a6a6",e}function U(r,t,e){const i=e?-r:r,a=new y(new g([new c(i,0),new c(i,t)]));return a.physicsData.colliderTag="road",a.style.fill=!1,a.style.stroke=!0,a.style.strokeStyle="white",a.style.lineWidth=5,a}function ut(r,t,e){const i={};for(let a=1;a<r;a++){const o=-t+t*2/r*a,l=new y(new g([new c(o,0),new c(o,e)]));l.style.stroke=!0,l.style.strokeStyle="white",l.style.lineWidth=5,l.style.fill=!1,l.style.lineDash=[30,50],i[`lane${a}`]=l}return i}const dt=ht(d.roadWidth,d.roadHeight),ft=U(d.allLanesWidth,d.roadHeight,!0),pt=U(d.allLanesWidth,d.roadHeight,!1),yt=ut(d.laneCount,d.allLanesWidth,d.roadHeight),H={road:dt,leftSideLine:ft,rightSideLine:pt,...yt};class gt{constructor(t){n(this,"connectingNeuron");n(this,"weight");this.connectingNeuron=t,this.weight=E()}getConnectionOutput(){}}var B,Q;class V{constructor(){m(this,B);n(this,"inputConnections");n(this,"bias");n(this,"rawInputValue");this.inputConnections=[],this.bias=E(),this.rawInputValue=null}connectToLayer(t){t.forEach(e=>{this.inputConnections.push(new gt(e))})}getOutput(){return this.rawInputValue===null?p(this,B,Q).call(this)>this.bias?1:0:this.rawInputValue}convertToJson(){return{bias:this.bias,connectionWeights:this.inputConnections.map(e=>e.weight)}}mutate(t){this.bias+=E(t),this.bias=A(this.bias),this.inputConnections.forEach(e=>{e.weight+=E(t),e.weight=A(e.weight)})}}B=new WeakSet,Q=function(){let t=0;return this.inputConnections.forEach(e=>{t+=e.connectingNeuron.getOutput()*e.weight}),t};class T{constructor(t){n(this,"layers");this.layers=[],t.forEach((e,s)=>{const i=[];for(let a=0;a<e;a++){const o=new V;s>0&&o.connectToLayer(this.layers[s-1]),i.push(o)}this.layers.push(i)})}static createFromData(t){const e=new T([]);return t.data.forEach((i,a)=>{const o=[];i.forEach(l=>{const h=new V;h.bias=l.bias,a>0&&(h.connectToLayer(e.layers[a-1]),h.inputConnections.forEach((w,G)=>{w.weight=l.connectionWeights[G]})),o.push(h)}),e.layers[a]=o}),e}feedFoward(t){this.layers[0].forEach((i,a)=>{i.rawInputValue=t[a]});const e=[];return this.layers[this.layers.length-1].forEach(i=>{e.push(i.getOutput())}),e}convertToJson(){const t={data:[]};for(let e=0;e<this.layers.length;e++){const s=this.layers[e],i=[];for(let a=0;a<s.length;a++){const o=s[a];i.push(o.convertToJson())}t.data.push(i)}return t}mutate(t){for(let e=0;e<this.layers.length;e++){const s=this.layers[e];for(let i=0;i<s.length;i++)s[i].mutate(t)}}clone(){const t=this.convertToJson();return T.createFromData(t)}}class j{constructor(){n(this,"signalsOut");this.signalsOut={up:0,right:0,down:0,left:0}}update(){}}class wt extends j{constructor(){super(),this.signalsOut.up=1}}class mt extends j{constructor(){super();n(this,"neuralNetwork");this.neuralNetwork=new T([7,8,4])}updateNetwork(e,s=!1){s&&console.table(e[3]);const i=this.neuralNetwork.feedFoward(e);this.signalsOut.up=i[0],this.signalsOut.right=i[1],this.signalsOut.down=i[2],this.signalsOut.left=i[3]}}class bt extends y{constructor(e,s){super(e);n(this,"reading");n(this,"distance");n(this,"visible",!1);this.reading=0,this.distance=s}update(){}onCollision(e){let s=null,i=1/0;e.forEach(h=>{const w=Math.abs(h.subtract(this.position.add(this.parentPosition)).magnitude());if(w<i&&(s=h,i=w),this.visible){const f=new b().processes[0].canvas.ctx;f.beginPath(),f.fillStyle="yellow",f.arc(h.x,h.y,10,0,Math.PI*2),f.globalOpacity=this.reading,f.fill(),f.globalOpacity=1}});const l=this.position.add(this.parentPosition).subtract(s).magnitude();this.reading=l/this.distance,new b().processes[0].canvas.ctx,this.visible}}class Ct extends y{constructor(t,e,s,i){super(t);for(let a=0;a<e+0;a++){const o=0-s/2+(s/(e-1)*a+1),l=new bt(new g([new c(0,0),new c(0,-i).rotate(o)]),i);l.style.strokeStyle="red",l.style.stroke=!0,l.style.fill=!1,l.physicsData.enabled=!0,l.physicsData.collidesWith=["road","traffic"],this.children.push(l),this.highlight()}}getReadings(){const t=[];return this.children.forEach(e=>{t.push(e.reading)}),t}highlight(t=!1){this.children.forEach(e=>{const s=e;s.style.stroke=t,s.visible=t})}}let R=null;var N,X;class v{constructor(){m(this,N);n(this,"library");if(this.library={},R)return R;R=this}async loadImage(t,e){const s=await p(this,N,X).call(this,e);this.library[t]=s}}N=new WeakSet,X=async function(t){const e=document.createElement("img");return e.src=t,new Promise(s=>{e.onload=()=>{s(e)}})};class _ extends y{constructor(e){super(e);n(this,"controls");n(this,"pedal");n(this,"turnSpeed");n(this,"carSpeed");n(this,"status");this.controls=new j,this.pedal=0,this.turnSpeed=5,this.rotation=0,this.carSpeed=20,this.status="enabled"}update(){this.status==="enabled"&&this.processControls()}processControls(){this.controls.signalsOut.up?this.pedal=C(this.pedal,1,.1):this.controls.signalsOut.down?this.pedal=C(this.pedal,-1,.1):this.pedal=C(this.pedal,0,.1),this.pedal!==0&&(this.controls.signalsOut.left?this.rotation-=this.turnSpeed*this.pedal:this.controls.signalsOut.right&&(this.rotation+=this.turnSpeed*this.pedal));let e=new c(0,-this.carSpeed);e=e.scale(this.pedal),e=e.rotate(this.rotation),this.position=this.position.add(e)}onCollision(e){this.status="crashed",this.physicsData.enabled=!1,this.style.opacity=.5,this.children[0].children.forEach(s=>{s.physicsData.enabled=!1})}}class xt extends _{constructor(t){super(t),this.controls=new wt,this.status="enabled"}}class St extends _{constructor(e){super(e);n(this,"sensors");n(this,"isHighlighted",!1);this.controls=new mt,this.status="enabled",this.sensors=new Ct(new g([]),7,180,500),this.children.push(this.sensors)}update(){const e=this.sensors.getReadings(),s=this.controls;this.isHighlighted?s.updateNetwork(e,!0):s.updateNetwork(e),super.update()}highlight(e=!1){e?(this.isHighlighted=!0,this.style.images[0]=new v().library.carFillYellow,this.children[0].highlight(!0)):(this.isHighlighted=!1,this.style.images[0]=new v().library.carFillBlue,this.children[0].highlight())}}let W=null;class M{constructor(){n(this,"elStartButton");n(this,"elFurthestDistanceText");n(this,"elGenerationText");n(this,"carsPerGeneration");n(this,"mutatingFactor");n(this,"startButtonPressed");n(this,"mutateButtonPressed");n(this,"clearButtonPressed",()=>{console.log("clearButtonPressed")});n(this,"elCarsPerGenerationSlider");n(this,"elCarsPerGenerationLabel");n(this,"elMutateFactorSlider");n(this,"elMutationFactorLabel");n(this,"elMutateButton");n(this,"elSaveButton");n(this,"elLoadButton");n(this,"elClearButton",document.getElementById("clearButton"));n(this,"generations",new b().processes[1]);n(this,"hasStarted",!1);if(this.elStartButton=document.getElementById("startButton"),this.elFurthestDistanceText=document.getElementById("distanceLabel"),this.elGenerationText=document.getElementById("generationLabel"),this.elCarsPerGenerationSlider=document.getElementById("carsPerGenerationRange"),this.elCarsPerGenerationLabel=document.getElementById("numberOfCarsPerGenerationLabel"),this.elMutateFactorSlider=document.getElementById("mutationRange"),this.elMutationFactorLabel=document.getElementById("mutationFactorLabel"),this.elMutateButton=document.getElementById("mutateButton"),this.carsPerGeneration=100,this.mutatingFactor=.2,this.startButtonPressed=()=>{this.hasStarted?this.generations.freshStart():this.generations.restartGeneration()},this.mutateButtonPressed=()=>{this.generations.createNewGeneration()},W)return W;W=this,this.elCarsPerGenerationSlider.oninput=(()=>{const t=this.elCarsPerGenerationSlider.value;this.elCarsPerGenerationLabel.innerHTML=t,this.carsPerGeneration=t}).bind(this),this.elMutateFactorSlider.oninput=(()=>{const t=this.elMutateFactorSlider.value;this.elMutationFactorLabel.innerHTML=t,this.mutatingFactor=t}).bind(this),this.elStartButton.addEventListener("click",()=>{this.elStartButton.innerHTML="Restart Generation",this.elMutateButton.disabled=!1}),this.elStartButton.addEventListener("click",()=>{this.startButtonPressed()}),this.elMutateButton.addEventListener("click",()=>{this.mutateButtonPressed()})}updateTexts(t="0",e="0"){this.elFurthestDistanceText.innerHTML=t,this.elGenerationText.innerHTML=e}updateGenerationsText(t){this.elGenerationText.innerHTML=t.toString()}}const Y=new v,u=[55,110],tt=new g([new c(-u[0],-u[1]),new c(u[0],-u[1]),new c(u[0],u[1]),new c(-u[0],u[1])]),et=(r="carFillYellow")=>{const t=new Z;return t.stroke=!1,t.fill=!1,t.fillStyle="red",t.addImage(Y.library[r],u[0]*2,u[1]*2),t.addImage(Y.library.carOutlines,u[0]*2,u[1]*2),t};function $(){const r=new xt(tt);return r.carSpeed=10,r.physicsData.colliderTag="traffic",r.style=et("carFillGrey"),r}function J(r=null){const t=new St(tt);return t.physicsData.enabled=!0,t.physicsData.collidesWith=["road","traffic"],t.style=et("carFillBlue"),r&&(t.controls.neuralNetwork=r.clone(),t.controls.neuralNetwork.mutate(new M().mutatingFactor)),t}function Pt(r,t,e,s){const i=new y(new g([]));i.style.fill=!1;const a=[];for(let o=0;o<r;o++){const l=new c(C(0,t,o/r)-t/2+t/r/2,e);a.push(l)}for(let o=0;o<r;o++)if(Math.random()>s){const l=$();l.position=a[o],i.children.push(l)}if(i.children.length===0){const o=$();o.position=a[Math.floor(Math.random()*(r-1))],i.children.push(o)}return i.children.length===r&&i.children.splice(Math.floor(Math.random()*(r-1)),1),i}function Gt(r,t,e,s,i,a){let o={};for(let l=0;l<r;l++){const h=t-e*l,w=Pt(s,i,h,a);o[`trafficRow${l}`]=w}return o}let D=null;var O,st;class Et{constructor(){m(this,O);n(this,"currentState",{generation:0,lanesPassed:0});if(D)return D;D=this}getBestCar(){const t=new b().processes[0],e=t.objects.aiCarGroup.children,s=t.objects.trafficCarGroup.children.map(o=>o.children[0].position.y),i=p(this,O,st).call(this,e,s);let a=e[0];return i[i.length-1].forEach(o=>{o.position.y<a.position.y&&(o.position.y,a=o)}),e.forEach(o=>{o.highlight(!1)}),a.highlight(!0),a}updateGeneration(t){this.currentState.generation=t,new M().updateGenerationsText(t)}}O=new WeakSet,st=function(t,e){const s=[];for(let o=0;o<e.length+1;o++)s.push([]);[0,...e].forEach((o,l)=>{t.forEach(h=>{h.position.y<o&&s[l].push(h)})});const a=[];for(let o=0;o<s.length;o++){const l=s[o];l.length>0&&a.push(l)}return a};var x,k;class kt{constructor(){m(this,x);n(this,"physicsWorld");n(this,"active");n(this,"trafficCarGroup");n(this,"aiCarGroup");n(this,"farthestCar");n(this,"bestNetwork");n(this,"observer",new Et);this.physicsWorld=new b().processes[0],this.active=!1,this.aiCarGroup=new y(new g([])),this.aiCarGroup.style.fill=!1,this.trafficCarGroup=new y(new g([])),this.trafficCarGroup.style.fill=!1,this.farthestCar=null,this.bestNetwork=null,window.addEventListener("keydown",t=>{t.key==="0"&&this.freshStart(),t.key==="1"&&this.restartGeneration(),t.key==="2"&&this.createNewGeneration()})}freshStart(){p(this,x,k).call(this)}restartGeneration(){this.clearCars(),p(this,x,k).call(this,this.bestNetwork?this.bestNetwork:null)}createNewGeneration(){const t=this.farthestCar;this.bestNetwork=t.controls.neuralNetwork,this.clearCars(),p(this,x,k).call(this,this.bestNetwork)}clearCars(){this.active?(this.active=!1,delete this.physicsWorld.objects.trafficCarGroup,delete this.physicsWorld.objects.aiCarGroup,this.aiCarGroup.children=[],this.trafficCarGroup.children=[],this.physicsWorld.colliderGroups.traffic=[]):console.error("no generation is not currently active")}update(){this.active&&(this.farthestCar=this.observer.getBestCar()),this.physicsWorld.canvas.cameraSubject=this.farthestCar}}x=new WeakSet,k=function(t=null){if(!this.active){this.active=!0;for(let s=0;s<new M().carsPerGeneration;s++){const i=t?J(t):J();this.aiCarGroup.children.push(i)}this.physicsWorld.addObject("aiCarGroup",this.aiCarGroup);const e=Gt(5,-700,1e3,d.laneCount,d.allLanesWidth*2,.5);Object.keys(e).forEach(s=>{this.trafficCarGroup.children.push(e[s])}),this.physicsWorld.addObject("trafficCarGroup",this.trafficCarGroup)}};const Tt="https://elbert-git.github.io/NeuralNetworkPlayground/assets/carOutlines.svg",vt="https://elbert-git.github.io/NeuralNetworkPlayground/assets/carFillYellow.svg",Lt="https://elbert-git.github.io/NeuralNetworkPlayground/assets/carFillBlue.svg",It="https://elbert-git.github.io/NeuralNetworkPlayground/assets/carFillGrey.svg";(async()=>{const r=new v;await r.loadImage("carOutlines",Tt),await r.loadImage("carFillYellow",vt),await r.loadImage("carFillBlue",Lt),await r.loadImage("carFillGrey",It);const t=new b,e=new ot;t.processes.push(e),Object.keys(H).forEach(i=>{e.addObject(i,H[i])});const s=new kt;t.processes.push(s),new M})();
